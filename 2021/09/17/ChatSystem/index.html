<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="A Simple Chat System"><meta name="keywords" content="Github"><meta name="author" content="ColdSnap"><meta name="copyright" content="ColdSnap"><title>A Simple Chat System | ColdSnap の Blog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.8.2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.8.2"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-4826942730187324',
  enable_page_level_ads: 'true'
});
</script><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '6.3.0'
} </script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ColdSnap の Blog" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Introduction"><span class="toc-number">1.</span> <span class="toc-text">1.Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Protocol-Implementation"><span class="toc-number">2.</span> <span class="toc-text">2.Protocol Implementation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Initialization"><span class="toc-number">2.1.</span> <span class="toc-text">2.1.Initialization</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Identity-Change-Protocol"><span class="toc-number">2.2.</span> <span class="toc-text">2.2.Identity Change Protocol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Join-Room-Protocol"><span class="toc-number">2.3.</span> <span class="toc-text">2.3.Join Room Protocol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Create-Room-Protocol"><span class="toc-number">2.4.</span> <span class="toc-text">2.4.Create Room Protocol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-Room-Content-Protocol"><span class="toc-number">2.5.</span> <span class="toc-text">2.5.Room Content Protocol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-Room-List-Protocol"><span class="toc-number">2.6.</span> <span class="toc-text">2.6.Room List Protocol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-Message-Protocol"><span class="toc-number">2.7.</span> <span class="toc-text">2.7.Message Protocol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-Delete-Room-Protocol"><span class="toc-number">2.8.</span> <span class="toc-text">2.8.Delete Room Protocol</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-9-Quit-Protocol"><span class="toc-number">2.9.</span> <span class="toc-text">2.9.Quit Protocol</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Discussion-About-Concurrency"><span class="toc-number">3.</span> <span class="toc-text">3.Discussion About Concurrency</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Multi-server-Architecture-Design"><span class="toc-number">4.</span> <span class="toc-text">4.Multi-server Architecture Design</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">ColdSnap</div><div class="author-info__description text-center">Welcome to ColdSnap の Blog</div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/Coldwave96">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">91</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">41</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">35</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://bodhidharmalu.github.io">Tigerlu</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://ghealer.top">Ghealer</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/background.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">ColdSnap の Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/Library">Library</a><a class="site-page" href="/Tools">Tools</a><a class="site-page" href="/about">About</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">A Simple Chat System</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-09-17</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Program/">Program</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Program/Java/">Java</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">1.7k</span><span class="post-meta__separator">|</span><span>阅读时长: 10 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>This is a simple example of distributed system implementation.</p>
<span id="more"></span>

<h2 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1.Introduction"></a>1.Introduction</h2><p>The project is to create a C&#x2F;S architectural model-based chat system. The chat system consists of a chat server and one or more chat clients. The chat server is able to accept multiple incoming TCP connections. The chat server can create a new chat room and move between existing chat rooms. Messages sent by a chat client will be broadcast to all clients which are in the same chat room.</p>
<h2 id="2-Protocol-Implementation"><a href="#2-Protocol-Implementation" class="headerlink" title="2.Protocol Implementation"></a>2.Protocol Implementation</h2><p>There are 8 protocols needs to be implemented in this chat system. At the beginning when a client connects to the server, the server will response with some initialized messages. After the socket is established, the client would be able to change identity, join rooms, ask for room list and room content information, create room, delete room, send messages, and quit the service. The following figures show how the server and client react to the eight protocols.</p>
<p><img src="/img/ChatSystem/Picture1.png" alt="Protocol diagram of the chat server"></p>
<p><img src="/img/ChatSystem/Picture2.png" alt="Protocol diagram of the chat client"></p>
<h3 id="2-1-Initialization"><a href="#2-1-Initialization" class="headerlink" title="2.1.Initialization"></a>2.1.Initialization</h3><p>The server will listen to the specified port. Once a client connects to the server, the server will start a thread to handle this socket and do following things:</p>
<ul>
<li>1.Responds with NewIdentity message.</li>
<li>2.Moves the client into MainHall.</li>
<li>3.Sends RoomChange message to all the clients in the MainHall.</li>
<li>4.Sends RoomList message to the client.</li>
<li>5.Sends RoomContent message to the client.</li>
</ul>
<p>Illustrated by the following figure:</p>
<p><img src="/img/ChatSystem/Picture3.png" alt="Initialization between the server and clients"></p>
<h3 id="2-2-Identity-Change-Protocol"><a href="#2-2-Identity-Change-Protocol" class="headerlink" title="2.2.Identity Change Protocol"></a>2.2.Identity Change Protocol</h3><p>When client sends a IdentityChange message to the server, the server will respond with a NewIdentity message. If the client wants to change to an invalid or existed identity, the value of former and identity field in NewIdentity message is same. And this NewIdentity message is only sent to the corresponding client. Otherwise, server will broadcast this NewIdentity message to all clients in the same chat room.</p>
<p><img src="/img/ChatSystem/Picture4.png" alt="Identity Change Protocol between the server and clients"></p>
<h3 id="2-3-Join-Room-Protocol"><a href="#2-3-Join-Room-Protocol" class="headerlink" title="2.3.Join Room Protocol"></a>2.3.Join Room Protocol</h3><p>When client sends a Join message to the server, the server will respond with a RoomChange message. If the client wants to join an invalid or non-existed room, the value of former and roomid in RoomChange message is same. And this RoomChange message is only sent to the corresponding client. Otherwise, server will broadcast this RoomChange message to all clients in the former and changed room. If client joins the MainHall, server will also send RoomList message and RoomComtents message after RoomChange message.</p>
<p><img src="/img/ChatSystem/Picture5.png" alt="Join Room Protocol between the server and clients"></p>
<h3 id="2-4-Create-Room-Protocol"><a href="#2-4-Create-Room-Protocol" class="headerlink" title="2.4.Create Room Protocol"></a>2.4.Create Room Protocol</h3><p>When client sends a CreateRoom message, the server will respond with a RoomList message. If the client wants to create a valid room, the server will respond with a RoomList message with the new room in the list.</p>
<p><img src="/img/ChatSystem/Picture6.png" alt="Create Room Protocol between the server and clients"></p>
<h3 id="2-5-Room-Content-Protocol"><a href="#2-5-Room-Content-Protocol" class="headerlink" title="2.5.Room Content Protocol"></a>2.5.Room Content Protocol</h3><p>When client sends a Who message, the server will respond with a RoomContents Message.</p>
<p><img src="/img/ChatSystem/Picture7.png" alt="Room Content Protocol between the server and clients"></p>
<h3 id="2-6-Room-List-Protocol"><a href="#2-6-Room-List-Protocol" class="headerlink" title="2.6.Room List Protocol"></a>2.6.Room List Protocol</h3><p>When client sends a List message, the server will respond with a RoomList message.</p>
<p><img src="/img/ChatSystem/Picture8.png" alt="Room List Protocol between the server and clients"></p>
<h3 id="2-7-Message-Protocol"><a href="#2-7-Message-Protocol" class="headerlink" title="2.7.Message Protocol"></a>2.7.Message Protocol</h3><p>When client input anything except for the commands, the client will take the input as messages and send the Message to the server. Then server will broadcast the Message to all clients in the same room.</p>
<p><img src="/img/ChatSystem/Picture9.png" alt="Message Protocol between the server and clients"></p>
<h3 id="2-8-Delete-Room-Protocol"><a href="#2-8-Delete-Room-Protocol" class="headerlink" title="2.8.Delete Room Protocol"></a>2.8.Delete Room Protocol</h3><p>When client sends Delete message, the server will do the following things:</p>
<ul>
<li>1.Check whether the room is existed, and the owner is the client or not.</li>
<li>2.If all conditions are met, server will move all users in that room to the MainHall and delete the room. Also, the server will send RoomChange message as well as RoomList message and RoomContents message to these clients.</li>
<li>3.Send RoomList message to the client which want to delete a room.</li>
</ul>
<p><img src="/img/ChatSystem/Picture10.png" alt="Delete Room Protocol between the server and client"></p>
<h3 id="2-9-Quit-Protocol"><a href="#2-9-Quit-Protocol" class="headerlink" title="2.9.Quit Protocol"></a>2.9.Quit Protocol</h3><p>Client just sends a Quit message to the server then shut down the program. If the client owns a room, then the server will remove the owner of this room. After that server will remove this client from its current room and check if it is the last client in that room. Server will delete that room if that room is empty, and its owner is also disconnected from the server. At last server removes the client socket from the socket list.</p>
<h2 id="3-Discussion-About-Concurrency"><a href="#3-Discussion-About-Concurrency" class="headerlink" title="3.Discussion About Concurrency"></a>3.Discussion About Concurrency</h2><p>Concurrency is an important feature of distributed system. Both services and applications provide resources that can be shared by clients in a distributed system. In this chat system, some concurrency has been realized, but there are also some problems have not been resolved when dealing with some concurrency.</p>
<p>First let’s discuss about the concurrency that the system has implemented. When the server starts, it will listen on the specified port. Once there is a socket connection request from the client, the server will create a new thread to process it. At the same time, the main program of the server is still listening to the specified port and waiting for a new socket connection request from another client. Different socket connections are processed by different threads and do not interfere with each other, so services and applications allow multiple client requests to be processed concurrently.</p>
<p>However, the concurrency implemented in this system is extremely limited. Next let’s discuss the limitation of the current system. First, the system does not consider high concurrency. After the client establishes a socket connection with the server, the thread handling the socket connection will run until the client actively exits the system. Although threads may occupy very few resources, the performance of the server is limited, and thread resources are limited as well. This will make it difficult for the system to deal with high concurrency. Second, there is no lock mechanism for access to shared resources in the system. Therefore, theoretically, different processes may operate on the same resource at the same time, which may lead to conflicts and inconsistent results. For example, if two users want to create a room with the same name at the same time, unpredictable error results may occur. Therefore, lock mechanism should be introduced to ensure the safe use of shared resources in a concurrent environment.</p>
<p>Similarly, the client also processes its socket connection with the server by thread. The client needs to listen to the user’s input and process the messages sent by the server at any time. This is the concurrency problem faced by the client. However, this chat system does not solve this problem, but processes user input and server pushed messages in the same thread. It may take two threads to deal with these two things separately. Then, like the server, this processing method also faces the same problem of accessing shared resource. In addition, if the user is entering something and the server pushes a message, it is also a problem how the separate thread scheme handles the situation.</p>
<h2 id="4-Multi-server-Architecture-Design"><a href="#4-Multi-server-Architecture-Design" class="headerlink" title="4.Multi-server Architecture Design"></a>4.Multi-server Architecture Design</h2><p>For a multi-server chat system, we have to do the following:</p>
<ul>
<li>1.High availability: No single node failure should cause service unavailability.</li>
<li>2.Easy to scale: Horizontally scalable, with the ability to adapt to different amounts of online users.</li>
<li>3.High concurrency and low latency: Be able to support a large number of users sending and receiving messages at the same time, with a delay of milliseconds from the message being sent to the delivery of all online ends.</li>
<li>4.Client compatibility: New applications are able to interoperate across multiple devices at the same time, such as web, mobile and desktop, and even smart TV.<br>Thus, the overall framework design is shown in the figure below.</li>
</ul>
<p><img src="/img/ChatSystem/Picture11.png" alt="The overall framework design of multi-server chat system"></p>
<p>The client layer is supposed to deal with compatibility issues with various devices, message channel management and maintenance, and data security.</p>
<p>The diversity of client implementation technologies leads to differences in the underlying data communication protocols between the client and the gateway. Therefore, the gateway layer is responsible for managing client connections, protocol conversion, logic for data security and efficient distribution of broadcast messages.</p>
<p>In addition to serving as a relay point for messages, the routing layer also assumes the role of load balancing and high availability. It is easier to expand capacity when the processing capacity of a single business node reaches a bottleneck. When a network failure occurs in a server cluster, it can be switched to the backup server cluster to ensure service availability.</p>
<p>The server layer handles the business messages of the chat system.<br>Now let’s deep dive into the multi-server chat system and focus on the message protocols.</p>
<p>For the client, it will try to connect to the gateway depending on the distance of the gateway in the list. Once the TCP keepalive connection established, the server can do the same thing as the current chat client.</p>
<p>There are two options for handling the communication between servers at router layer.</p>
<p>First option is to provide a master server. The master server has a router table. All messages are pushed to the master server, which distributes the messages to different service servers according to the router table. This places a high demand on the performance of the master server.</p>
<p>Another option is to implement a message queue based on a publish-subscribe system. The basic structure is shown in the figure bellow.</p>
<p><img src="/img/ChatSystem/Picture12.png" alt="Cross-server communication via message queues"></p>
<p>Assume there is a client 1 login in at the ChatServer 1 and a client 2 login in at the ChatServer 2. ChatServer 1 and ChatServer 2 will subscribe to messages about “client 1” and “client 2”in the message queue respectively. If client 2 sends a message to client 1, the ChatServer 2 will publish the message with a flag “client 1” to the message queue. Then message queue will notify ChatServer 1 that someone sends a message to client 1. Chatserver 1 will access this message and send it to client 1.</p>
<p>Message queues also have disadvantages. First, once the message queue crashed, so doed the entire system. Second, message queue makes the system more complex. How to ensure that messages are not consumed repeatedly? How to deal with the case of message loss? How to ensure the sequential nature of message delivery? These are the challenges that need to be addressed. Finally, there is the issue of consistency. If a request requires multiple operations, but one of them fails. Although the feedback to the user is success, the request is actually not fully executed. In general, however, the advantages of message queues outweigh the disadvantages, so it is a better choice than the first option.</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">ColdSnap</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://coldwave96.github.io/2021/09/17/ChatSystem/">https://coldwave96.github.io/2021/09/17/ChatSystem/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://coldwave96.github.io">ColdSnap の Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Github/">Github</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/09/17/RoutingInP2P/"><i class="fa fa-chevron-left">  </i><span>Routing in P2P Overlay Networks</span></a></div><div class="next-post pull-right"><a href="/2021/06/08/SoftwareDefinedPerimeter/"><span>开源组件实现 Software Defined Perimeter</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == 'true';
var verify = 'false' == 'true';
var record_ip = '' == 'true';
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  recordIP:record_ip,
  appId:'R82KAmOmkqMWNJs72Fx4ub1O-gzGzoHsz',
  appKey:'Sq4B8VcTqxJ2qCeJLJa3KbKz',
  placeholder:'Please leave something ^.^',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(/img/background.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2019 - 2025 By ColdSnap</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="icp"><a><span>Welcome to my world ^.^</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.8.2"></script><script src="/js/fancybox.js?version=1.8.2"></script><script src="/js/sidebar.js?version=1.8.2"></script><script src="/js/copy.js?version=1.8.2"></script><script src="/js/fireworks.js?version=1.8.2"></script><script src="/js/transition.js?version=1.8.2"></script><script src="/js/scroll.js?version=1.8.2"></script><script src="/js/head.js?version=1.8.2"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>